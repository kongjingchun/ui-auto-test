# 无外网环境部署说明

## 概述

本项目已支持在无外网环境的Linux系统上运行。主要修改了ChromeDriver的获取策略，优先使用本地chromedriver文件。

## 部署步骤

### 1. 准备ChromeDriver文件

在部署到无外网环境前，需要准备匹配的chromedriver文件：

1. **确定Chrome浏览器版本**
   ```bash
   google-chrome --version
   # 或
   chromium --version
   ```

2. **下载匹配的ChromeDriver**
   - 在有网络的机器上下载对应版本的chromedriver
   - 下载地址：https://chromedriver.chromium.org/downloads
   - 或使用镜像：https://mirrors.huaweicloud.com/chromedriver

3. **放置到项目目录**
   ```bash
   # 将chromedriver文件复制到项目目录
   cp chromedriver /path/to/XuetangUI/driver_files/chromedriver
   
   # 确保有执行权限
   chmod +x /path/to/XuetangUI/driver_files/chromedriver
   ```

### 2. 验证文件结构

确保项目目录结构如下：
```
XuetangUI/
├── driver_files/
│   └── chromedriver          # ChromeDriver可执行文件
├── config/
│   └── driver_config.py      # 已修改，支持本地路径优先
└── ...
```

### 3. 工作原理

修改后的代码会按以下顺序查找ChromeDriver：

1. **优先使用本地路径**：`driver_files/chromedriver`
   - 如果文件存在且有执行权限，直接使用
   - 适用于无外网环境

2. **备用网络下载**：如果本地不存在，尝试使用webdriver-manager下载
   - 需要网络连接
   - 无外网环境下会失败，但会给出清晰的错误提示

### 4. 常见问题

#### 问题1：找不到chromedriver
**错误信息**：`FileNotFoundError: 无法获取ChromeDriver！`

**解决方案**：
- 检查 `driver_files/chromedriver` 文件是否存在
- 确保文件有执行权限：`chmod +x driver_files/chromedriver`
- 确保chromedriver版本与Chrome浏览器版本匹配

#### 问题2：版本不匹配
**错误信息**：`SessionNotCreatedException: This version of ChromeDriver only supports Chrome version XX`

**解决方案**：
- 查看Chrome版本：`google-chrome --version`
- 下载匹配的chromedriver版本
- 替换 `driver_files/chromedriver` 文件

#### 问题3：权限问题
**错误信息**：`Permission denied`

**解决方案**：
```bash
chmod +x driver_files/chromedriver
```

### 5. Linux系统特殊配置

对于Linux无外网环境，可能需要以下额外配置：

#### 安装Chrome/Chromium
```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y chromium-browser

# CentOS/RHEL
sudo yum install -y chromium
```

#### 无头模式（可选）
如果需要无头模式运行，可以在 `driver_config.py` 中添加：
```python
options.add_argument("--headless")
```

#### 显示服务器（Xvfb）
如果系统没有图形界面，可以使用Xvfb：
```bash
sudo apt-get install -y xvfb
export DISPLAY=:99
Xvfb :99 -screen 0 1024x768x24 &
```

## 测试验证

部署完成后，运行测试验证：

```bash
# 运行单个测试用例
pytest testcases/testgqkt/test_001_user.py -v

# 运行所有测试
pytest testcases/ -v
```

## 注意事项

1. **版本匹配**：确保chromedriver版本与Chrome浏览器版本匹配
2. **文件权限**：确保chromedriver有执行权限
3. **路径正确**：确保chromedriver文件在正确的路径下
4. **系统依赖**：确保系统已安装必要的依赖库

## 回退方案

如果需要回退到原来的自动下载方式，可以：
1. 删除 `driver_files/chromedriver` 文件
2. 确保系统有网络连接
3. 代码会自动使用webdriver-manager下载

